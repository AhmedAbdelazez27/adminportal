<div class="view-requestplaint-container">
    <section>
        <div class="container services">
            <div *ngIf="!mainApplyService" class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
                </div>
                <p class="mt-3">{{ 'COMMON.LOADING_DATA' | translate }}</p>
            </div>

            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a routerLink="/mainServices/services">Services</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ 'VIEW_REQUESTPLAINT.TITLE' | translate }}
                    </li>
                </ol>
            </nav>

            <div class="service-info-card mb-4 ">
              <div class="w-100">
                <h4 class="title mb-2">{{ 'VIEW_REQUESTPLAINT.TITLE' | translate }}</h4>
                <div class="row">
                  <h6 class="fw-bold">{{ mainApplyService.service?.serviceName }}</h6>
                  <div class="row">
                    <div class="col-xl-6">
                      <p class="mb-1">
                        <strong>{{ 'mainApplyServiceResourceName.applyNo' | translate  }}:</strong>
                        {{mainApplyService.applyNo}}
                      </p>
                    </div>
                    <div class="col-xl-6">
                      <p class="mb-1">
                        <strong>{{ 'mainApplyServiceResourceName.applyDate' | translate }}:</strong>
                        {{formatDate(mainApplyService.applyDate)}}
                      </p>
                    </div>
                    <div class="col-xl-6">
                      <p class="mb-1">
                        <strong>{{ 'mainApplyServiceResourceName.userName' | translate }}: </strong>
                        {{mainApplyService.userName}}
                      </p>
                    </div>
                    <div class="col-xl-6">
                      <p class="mb-0" *ngIf="mainApplyService.permitNumber">
                        <strong>{{ 'mainApplyServiceResourceName.permitNumber' | translate }}: </strong>
                        {{mainApplyService.permitNumber}}
                      </p>
                    </div>
                    <div class="col-xl-6">
                      <span class="badge bg-primary">{{mainApplyService.lastStatus}}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="mainApplyService" class="row">
                <div class="col-lg-3 mb-4">
                  <div class="main-container h-100">
                    <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-route me-2"></i>{{ 'WORKFLOW.PROCESS_STEPS' | translate }} </h6>
                    <div class="workflow-timeline" *ngIf="workFlowSteps?.length">
                      <div *ngFor="let step of workFlowSteps; let i = index; trackBy: trackByStepId"
                           class="workflow-step-item" [class.completed]="isStepCompleted(step.serviceStatus)"
                           [class.rejected]="isStepRejected(step.serviceStatus)"
                           [class.pending]="isStepPending(step.serviceStatus)"
                           [class.last-step]="i === workFlowSteps.length - 1">

                        <div class="step-circle" [style.background-color]="getStatusColor(step.serviceStatus)"
                             [style.border-color]="getStatusColor(step.serviceStatus)">
                          <i [class]="getStatusIcon(step.serviceStatus)"></i>
                        </div>

                        <div class="step-line" *ngIf="i < workFlowSteps.length - 1"
                             [class.completed-line]="isStepCompleted(step.serviceStatus)"></div>

                        <div>
                          <div class="step-header">
                            <div class="step-number">
                              {{ 'WORKFLOW.STEP' | translate }} {{ step.stepOrder }}
                            </div>
                            <div class="step-status" [style.color]="getStatusColor(step.serviceStatus)">
                              <i [class]="getStatusIcon(step.serviceStatus)" class="me-1"></i>
                              {{ step.serviceStatusName || (getStatusLabel(step.serviceStatus) | translate) }}
                            </div>
                          </div>
                          <h6 class="department-name">{{ step.departmentName }}</h6>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-9 mb-4">
                  <div id="statusInfo">
                    <div class="main-container mb-4">
                      <div id="workFlowStep" class="mb-3">
                        <div *ngIf="workFlowQuery?.length; else noWorkflow">
                          <div *ngIf="workFlowQuery[0].serviceStatus == 1" class="alert alert-success text-center">
                            {{ 'mainApplyServiceResourceName.agree' | translate }}
                          </div>

                          <div *ngIf="workFlowQuery[0].serviceStatus == 2" class="alert alert-danger text-center">
                            {{ 'mainApplyServiceResourceName.disagree' | translate }}
                          </div>

                          <div *ngIf="workFlowQuery[0].serviceStatus == 3" class="alert alert-warning text-center">
                            <div class="popover__wrapper">
                              <a href="javascript:void(0);">
                                <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                              </a>
                              <div class="popover__content w-60">
                                <p class="popover__message">{{ workFlowQuery[0].refuseReason }}</p>
                              </div>
                            </div>
                          </div>

                          <ng-container *ngIf="workFlowQuery[0].serviceStatus != 1
           && workFlowQuery[0].serviceStatus != 2
           && workFlowQuery[0].serviceStatus != 3">
                            <ng-template #returnForModification>
                              <div class="alert alert-warning text-center">
                                <div class="popover__wrapper">
                                  <a href="javascript:void(0);">
                                    <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                                  </a>
                                  <div class="popover__content w-60">
                                    <p class="popover__message">{{ mainApplyService.reasonForModification }}</p>
                                  </div>
                                </div>
                              </div>
                            </ng-template>

                            <div *ngIf="mainApplyService.lastStatus != 'إرجاع الطلب للتعديل'; else returnForModification">
                              <div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">
                                <div *ngIf="serviceDepartmentActions == 1" class="d-flex flex-wrap gap-2 justify-content-center">
                                  <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                                    {{ 'mainApplyServiceResourceName.taksis' | translate }}
                                  </button>
                                </div>

                                <div *ngIf="serviceDepartmentActions == 2" class="d-flex flex-wrap gap-2 justify-content-center">
                                  <button type="button" (click)="acceptbtn()" class="btn btn-success">
                                    {{ 'mainApplyServiceResourceName.accep' | translate }}
                                  </button>
                                  <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                                    {{ 'mainApplyServiceResourceName.refu' | translate }}
                                  </button>
                                  <button type="button" (click)="rejectWithReasonbtn()" class="btn btn-warning">
                                    {{ 'mainApplyServiceResourceName.refusefor' | translate }}
                                  </button>
                                </div>

                                <div *ngIf="serviceDepartmentActions == 3" class="d-flex flex-wrap gap-2 justify-content-center">
                                  <button type="submit" (click)="returnForModificationsbtn()" class="btn btn-outline-secondary">
                                    {{ 'mainApplyServiceResourceName.taksis' | translate }}
                                  </button>
                                </div>

                                <div *ngIf="serviceDepartmentActions !== 1 && serviceDepartmentActions !== 2 && serviceDepartmentActions !== 3"
                                     class="d-flex flex-wrap gap-2 justify-content-center">
                                </div>
                              </div>
                              <!--<div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">
                <button type="button" (click)="acceptbtn()" class="btn btn-success">
                  {{ 'mainApplyServiceResourceName.accep' | translate }}
                </button>

                <button type="button" (click)="rejectWithReasonbtn()" class="btn btn-danger">
                  {{ 'mainApplyServiceResourceName.refusefor' | translate }}
                </button>

                <button *ngIf="mainApplyService.serviceId == 1 || mainApplyService.serviceId == 1001"
                        type="button" (click)="returnForModificationsbtn()" class="btn btn-dark">
                  {{ 'mainApplyServiceResourceName.ReturnForModifications' | translate }}
                </button>
              </div>-->
                            </div>
                          </ng-container>
                        </div>

                        <ng-template #noWorkflow>
                          <ng-template #noWorkflowReturn>
                            <div class="alert alert-warning text-center">
                              <div class="popover__wrapper">
                                <a href="javascript:void(0);">
                                  <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                                </a>
                                <div class="popover__content w-60">
                                  <p class="popover__message">{{ mainApplyService.reasonForModification }}</p>
                                </div>
                              </div>
                            </div>
                          </ng-template>

                          <div *ngIf="mainApplyService.lastStatus != 'إرجاع الطلب للتعديل'; else noWorkflowReturn">
                            <div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">
                              <div *ngIf="serviceDepartmentActions == 1" class="d-flex flex-wrap gap-2 justify-content-center">
                                <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                                  {{ 'mainApplyServiceResourceName.taksis' | translate }}
                                </button>
                              </div>

                              <div *ngIf="serviceDepartmentActions == 2" class="d-flex flex-wrap gap-2 justify-content-center">
                                <button type="button" (click)="acceptbtn()" class="btn btn-success">
                                  {{ 'mainApplyServiceResourceName.accep' | translate }}
                                </button>
                                <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                                  {{ 'mainApplyServiceResourceName.refu' | translate }}
                                </button>
                                <button type="button" (click)="rejectWithReasonbtn()" class="btn btn-warning">
                                  {{ 'mainApplyServiceResourceName.refusefor' | translate }}
                                </button>
                              </div>

                              <div *ngIf="serviceDepartmentActions == 3" class="d-flex flex-wrap gap-2 justify-content-center">
                                <button type="submit" (click)="returnForModificationsbtn()" class="btn btn-outline-secondary">
                                  {{ 'mainApplyServiceResourceName.taksis' | translate }}
                                </button>
                              </div>

                              <div *ngIf="serviceDepartmentActions !== 1 && serviceDepartmentActions !== 2 && serviceDepartmentActions !== 3"
                                   class="d-flex flex-wrap gap-2 justify-content-center">
                              </div>
                            </div>
                            <!--<div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">
              <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                {{ 'mainApplyServiceResourceName.taksis' | translate }}
              </button>

              <button type="button" (click)="acceptbtn()" class="btn btn-success">
                {{ 'mainApplyServiceResourceName.accep' | translate }}
              </button>

              <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                {{ 'mainApplyServiceResourceName.refu' | translate }}
              </button>

              <button type="button" (click)="rejectWithReasonbtn()" class="btn btn-warning">
                {{ 'mainApplyServiceResourceName.refusefor' | translate }}
              </button>

              <button *ngIf="mainApplyService.serviceId == 1 || mainApplyService.serviceId == 1001"
                      type="button" (click)="returnForModificationsbtn()" class="btn btn-secondary">
                {{ 'mainApplyServiceResourceName.ReturnForModifications' | translate }}
              </button>
            </div>-->
                          </div>
                        </ng-template>

                        <div *ngIf="!workFlowQuery?.length
|| workFlowQuery[0].serviceStatus == 4
|| workFlowQuery[0].serviceStatus == 5; else readonlyNotes"
                             class="mt-3">
                          <div class="form-group">
                            <label for="NotesForApproving" class="control-label mb-2">
                              {{ 'mainApplyServiceResourceName.notesConsent' | translate }}
                            </label>
                            <textarea id="NotesForApproving" class="form-control"
                                      [(ngModel)]="mainApplyService.notesForApproving"
                                      (ngModelChange)="onNotesChange($event)" [disabled]="!isEditMode"></textarea>
                          </div>
                        </div>

                        <ng-template #readonlyNotes>
                          <div class="form-group">
                            <label for="NotesForApproving" class="control-label col-md-12">
                              {{ 'mainApplyServiceResourceName.notes' | translate }}
                            </label>
                            <textarea id="NotesForApproving" class="form-control" readonly>{{ mainApplyService.notesForApproving }}</textarea>
                          </div>
                        </ng-template>
                      </div>
                    </div>
                  </div>

                  <div id="mainInfo">
                    <div class="main-container h-100">
                      <div class=" mb-4">
                        <div class="step-content">
                          <h5 class="mb-3 gold">{{ 'CHARITY_EVENT_PERMIT.BASIC' | translate }}</h5>
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.SERVICE_NAME' | translate }}</label>
                              <div class="form-control-plaintext">{{ mainApplyService?.service?.serviceName || '-' }}</div>
                            </div>

                            <div class="col-md-6 mb-3">
                              <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.SERVICE_REFERENCE_NO' | translate }}</label>
                              <div class="form-control-plaintext">{{ mainApplyService?.service?.serviceRefrenceNo || '-' }}</div>
                            </div>

                            <div class="col-12 mb-3">
                              <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.SERVICE_DESCRIPTION' | translate }}</label>
                              <div class="form-control-plaintext">{{ mainApplyService?.service?.descriptionAr || '-' }}</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class=" mb-4" *ngIf="mainApplyService?.attachments?.length">
                        <div class="step-content">
                          <h5 class="mb-3 gold">{{ 'COMMON.ATTACHMENTS' | translate }}</h5>
                          <div *ngIf="mainApplyService.attachments?.length; else noAtts">
                            <div class="row">
                              <div class="col-xl-4 col-lg-6 mb-4"
                                   *ngFor="let attachment of mainApplyService.attachments">
                                <div class="attachment-box">
                                  <h6 class="card-title"> {{ attachment.attachmentTitle || ('CHARITY_EVENT_PERMIT.ATTACHMENT' | translate) }} </h6>
                                  <p class="mb-4">{{ 'COMMON.UPLOADED_ON' | translate }}: {{ formatDateTime(attachment.lastModified) }}</p>
                                  <div class="d-flex justify-content-between mt-auto">
                                    <button class="btn btn-next-style me-2"
                                            (click)="viewAttachment(attachment)">
                                      <i class="fas fa-eye me-1"></i>{{ 'COMMON.VIEW' | translate }}
                                    </button>
                                    <button class="btn btn-download-style"
                                            (click)="downloadAttachment(attachment)">
                                      <i class="fas fa-download me-1"></i>{{ 'COMMON.DOWNLOAD' | translate }}
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <ng-template #noAtts>
                            <div class="alert alert-info">
                              {{'CHARITY_EVENT_PERMIT.NO_ATTACHMENTS' | translate }}
                            </div>
                          </ng-template>
                        </div>
                      </div>

                      <div class=" mb-4" *ngIf="mainApplyService?.requestPlaintEvidences?.length">
                        <div class="step-content">
                          <h5 class="mb-3 gold">{{ 'REQUEST_INFO.EVIDENCE' | translate }}</h5>
                          <ul>
                            <li *ngFor="let evidence of mainApplyService.requestPlaintEvidences">
                              <p>{{ evidence.evidence }}</p>
                            </li>
                          </ul>
                        </div>
                      </div>

                      <div class="" *ngIf="mainApplyService.requestPlaintJustifications?.length">
                        <div class="step-content">
                          <h5 class="mb-3 gold">{{ 'REQUEST_INFO.JUSTIFICATIONS' | translate }}</h5>
                          <ul>
                            <li *ngFor="let justification of mainApplyService.requestPlaintJustifications">
                              <p>{{ justification.justification }}</p>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </section>
</div>
