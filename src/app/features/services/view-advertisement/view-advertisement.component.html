<div class="view-distribution-site-permit-container">
  <section>
    <div class="container ">
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
        </div>
        <p class="mt-3">{{ 'COMMON.LOADING_DATA' | translate }}</p>
      </div>

      <div *ngIf="hasError && !isLoading" class="text-center py-5">
        <div class="error-container">
          <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
          <h4 class="text-danger mt-3">{{ 'COMMON.ERROR_OCCURRED' | translate }}</h4>
          <p class="text-muted">{{ errorMessage }}</p>
          <div *ngIf="errorDetails" class="alert alert-light mt-3">
            <small class="text-muted">{{ 'COMMON.ERROR_DETAILS' | translate }}:</small>
            <br>
            <code>{{ errorDetails }}</code>
          </div>
          <div class="alert alert-info mt-3">
            <small class="text-muted">{{ 'COMMON.SUGGESTIONS' | translate }}:</small>
            <br>
            <span>{{ getErrorContext() }}</span>
          </div>
          <div class="mt-4">
            <button type="button" class="btn btn-primary me-2" (click)="retryLoadingData()">
              <i class="fas fa-redo me-2"></i>{{ 'COMMON.RETRY' | translate }}
            </button>
            <button type="button" class="btn btn-warning me-2" (click)="refreshPage()">
              <i class="fas fa-sync-alt me-2"></i>{{ 'COMMON.REFRESH_PAGE' | translate }}
            </button>
            <button type="button" class="btn btn-success me-2" (click)="checkServiceAvailability()">
              <i class="fas fa-check-circle me-2"></i>{{ 'COMMON.CHECK_SERVICE' | translate }}
            </button>
            <button type="button" class="btn btn-info me-2" (click)="contactSupport()">
              <i class="fas fa-headset me-2"></i>{{ 'COMMON.CONTACT_SUPPORT' | translate }}
            </button>
            <button type="button" class="btn btn-outline-secondary me-2" (click)="copyErrorDetails()">
              <i class="fas fa-copy me-2"></i>{{ 'COMMON.COPY_ERROR' | translate }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="goBack()">
              <i class="fas fa-arrow-left me-2"></i>{{ 'COMMON.BACK' | translate }}
            </button>
          </div>
        </div>
      </div>

      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a routerLink="/mainServices/services">{{ 'mainApplyServiceResourceName.navigateService' | translate }}</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ 'ADVERTISEMENT.VIEW_TITLE' | translate }}</li>
        </ol>
      </nav>

      <div *ngIf="!isLoading && mainApplyService">
        <div class="service-info-card mb-4">

          <div class="w-100">
            <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
              <h4 class="title ">{{ 'ADVERTISEMENT.VIEW_TITLE' | translate }}</h4>
              <!--<button *ngIf="targetWorkFlowStep && isEditMode && workFlowQuery?.length" type="button" class="btn btn-gold" data-bs-toggle="modal" data-bs-target="#addcommentsModal">
                <i class="fas fa-plus me-2"></i>
                {{ 'COMMON.ADD_COMMENT' | translate }}
              </button>-->
            </div>

            <div class="row">
              <h6 class="fw-bold">{{ mainApplyService.service?.serviceName }}</h6>
              <div class="row">
                <div class="col-xl-6">
                  <p class="mb-1">
                    <strong>{{ 'mainApplyServiceResourceName.applyNo' | translate  }}:</strong>
                    {{mainApplyService.applyNo}}
                  </p>
                </div>
                <div class="col-xl-6">
                  <p class="mb-1">
                    <strong>{{ 'mainApplyServiceResourceName.applyDate' | translate }}:</strong>
                    {{formatDate(mainApplyService.applyDate)}}
                  </p>
                </div>
                <div class="col-xl-6">
                  <p class="mb-1">
                    <strong>{{ 'mainApplyServiceResourceName.userName' | translate }}: </strong>
                    {{mainApplyService.userName}}
                  </p>
                </div>
                <div class="col-xl-6">
                  <p class="mb-0" *ngIf="mainApplyService.permitNumber">
                    <strong>{{ 'mainApplyServiceResourceName.permitNumber' | translate }}: </strong>
                    {{mainApplyService.permitNumber}}
                  </p>
                </div>
                <div class="col-xl-6">
                  <span class="badge bg-primary">{{mainApplyService.lastStatus}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-3 mb-4">
            <div class="main-container h-100">
              <div class="">
                <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-route me-2"></i>{{ 'WORKFLOW.PROCESS_STEPS' | translate }} </h6>
                <div class="workflow-timeline" *ngIf="workFlowSteps && workFlowSteps.length > 0">
                  <div *ngFor="let step of workFlowSteps; let i = index; trackBy: trackByStepId"
                       class="workflow-step-item" [class.completed]="isStepCompleted(step.serviceStatus)"
                       [class.rejected]="isStepRejected(step.serviceStatus)"
                       [class.pending]="isStepPending(step.serviceStatus)"
                       [class.last-step]="i === workFlowSteps.length - 1">

                    <div class="step-circle" [style.background-color]="getStatusColor(step.serviceStatus)"
                         [style.border-color]="getStatusColor(step.serviceStatus)">
                      <i [class]="getStatusIcon(step.serviceStatus)"></i>
                    </div>

                    <div class="step-line" *ngIf="i < workFlowSteps.length - 1"
                         [class.completed-line]="isStepCompleted(step.serviceStatus)"></div>
                    <div>
                      <div class="step-header">
                        <div class="step-number">
                          <!-- {{ 'WORKFLOW.STEP' | translate }} {{step.stepOrder}} -->
                          {{ step?.stepName || (('WORKFLOW.STEP' | translate) + ' ' + step?.stepOrder) }}
                        </div>
                        <div class="step-status" [style.color]="getStatusColor(step.serviceStatus)">
                          <i [class]="getStatusIcon(step.serviceStatus)" class="me-1"></i>
                          {{step.serviceStatusName || (getStatusLabel(step.serviceStatus) | translate)}}
                        </div>
                      </div>
                      <h6 class="department-name">{{step.departmentName}}</h6>
                      <button type="button" class="btn btn-link p-0"
                              (click)="openHistoryModal(step.workFlowHistories || [])">
                        <i class="bi bi-clock-history me-1"></i>{{
'mainApplyServiceResourceName.WORKFLOW.VIEW_HISTORY' |
                     translate
                        }}
                      </button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div class="col-lg-9 mb-4">
            <div id="statusInfo">
              <div class="main-container mb-4">
                <div id="workFlowStep" class="mb-3">

                  <div *ngIf="allApproved; else normalWorkflow">
                    <div class="form-group mb-3">
                      <label for="NotesForApproving" class="control-label mb-2">
                        {{ 'mainApplyServiceResourceName.notesConsent' | translate }}
                      </label>
                      <textarea id="NotesForApproving" class="form-control" readonly>{{ mainApplyService.notesForApproving }}</textarea>
                    </div>

                    <div class="alert alert-success text-center">
                      {{ 'mainApplyServiceResourceName.agree' | translate }}
                    </div>
                  </div>
                  <ng-template #normalWorkflow>

                    <div *ngIf="!workFlowQuery?.length || workFlowQuery[0].serviceStatus == 4 || workFlowQuery[0].serviceStatus == 5; else readonlyNotes"
                         class="mt-3">
                      <div class="form-group mb-3">
                        <label for="NotesForApproving" class="control-label mb-2">
                          {{ 'mainApplyServiceResourceName.notesConsent' | translate }}
                        </label>
                        <textarea id="NotesForApproving" class="form-control"
                                  [(ngModel)]="mainApplyService.notesForApproving"
                                  (ngModelChange)="onNotesChange($event)" [disabled]="!isEditMode"></textarea>
                      </div>
                    </div>

                    <ng-template #readonlyNotes>
                      <div class="form-group mb-3">
                        <label for="NotesForApproving" class="control-label col-md-12">
                          {{ 'mainApplyServiceResourceName.notes' | translate }}
                        </label>
                        <textarea id="NotesForApproving" class="form-control" readonly> {{ mainApplyService.notesForApproving }}</textarea>
                      </div>
                    </ng-template>
                    <div *ngIf="workFlowQuery?.length; else noWorkflow">

                      <div *ngIf="workFlowQuery[0].serviceStatus == 1" class="alert alert-success text-center">
                        {{ 'mainApplyServiceResourceName.agree' | translate }}
                      </div>

                      <div *ngIf="workFlowQuery[0].serviceStatus == 2" class="alert alert-danger text-center">
                        {{ 'mainApplyServiceResourceName.disagree' | translate }}
                      </div>

                      <div *ngIf="workFlowQuery[0].serviceStatus == 7" class="alert alert-warning text-center">
                        <div class="popover__wrapper">
                          <a href="javascript:void(0);">
                            <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                          </a>
                          <div class="popover__content w-60">
                            <p class="popover__message">{{ workFlowQuery[0].refuseReason }}</p>
                          </div>
                        </div>
                      </div>

                      <ng-container *ngIf="workFlowQuery[0].serviceStatus != 1 && workFlowQuery[0].serviceStatus != 2 && workFlowQuery[0].serviceStatus != 7">
                        <ng-template #returnForModification>
                          <div class="alert alert-warning text-center">
                            <div class="popover__wrapper">
                              <a href="javascript:void(0);">
                                <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                              </a>
                              <div class="popover__content w-60">
                                <p class="popover__message">{{ mainApplyService.reasonForModification }}</p>
                              </div>
                            </div>
                          </div>
                        </ng-template>

                        <div *ngIf="mainApplyService.lastStatus != 'إرجاع للتعديل'; else returnForModification">
                          <div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">

                            <div *ngIf="serviceDepartmentActions?.includes(1)" class="d-flex flex-wrap gap-2 justify-content-center">
                              <button type="button" (click)="acceptbtn()" class="btn btn-success">
                                {{ 'mainApplyServiceResourceName.accep' | translate }}
                              </button>
                              <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                                {{ 'mainApplyServiceResourceName.refu' | translate }}
                              </button>
                            </div>

                            <div *ngIf="serviceDepartmentActions?.includes(2)" class="d-flex flex-wrap gap-2 justify-content-center">
                              <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                                {{ 'SERVICE_SETTING.DEPARTMENT_ACTION_REVIEW' | translate }}
                              </button>
                            </div>

                            <div *ngIf="serviceDepartmentActions?.includes(3)" class="d-flex flex-wrap gap-2 justify-content-center">
                              <button type="submit" (click)="returnForModificationsbtn()" class="btn btn-outline-secondary">
                                {{ 'mainApplyServiceResourceName.ReturnForModifications' | translate }}
                              </button>
                            </div>

                            <div *ngIf="!hasActionButtons" class="d-flex flex-wrap gap-2 justify-content-center">
                            </div>

                          </div>
                        </div>
                      </ng-container>
                    </div>

                    <ng-template #noWorkflow>
                      <ng-template #noWorkflowReturn>
                        <div class="alert alert-warning text-center">
                          <div class="popover__wrapper">
                            <a href="javascript:void(0);">
                              <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                            </a>
                            <div class="popover__content w-60">
                              <p class="popover__message">{{ mainApplyService.reasonForModification }}</p>
                            </div>
                          </div>
                        </div>
                      </ng-template>

                      <div *ngIf="mainApplyService.lastStatus != 'إرجاع للتعديل'; else noWorkflowReturn">
                        <div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">

                          <div *ngIf="serviceDepartmentActions?.includes(1)" class="d-flex flex-wrap gap-2 justify-content-center">
                            <button type="button" (click)="acceptbtn()" class="btn btn-success">
                              {{ 'mainApplyServiceResourceName.accep' | translate }}
                            </button>
                            <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                              {{ 'mainApplyServiceResourceName.refu' | translate }}
                            </button>
                          </div>

                          <div *ngIf="serviceDepartmentActions?.includes(2)" class="d-flex flex-wrap gap-2 justify-content-center">
                            <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                              {{ 'SERVICE_SETTING.DEPARTMENT_ACTION_REVIEW' | translate }}
                            </button>
                          </div>

                          <div *ngIf="serviceDepartmentActions?.includes(3)" class="d-flex flex-wrap gap-2 justify-content-center">
                            <button type="submit" (click)="returnForModificationsbtn()" class="btn btn-outline-secondary">
                              {{ 'mainApplyServiceResourceName.ReturnForModifications' | translate }}
                            </button>
                          </div>

                          <div *ngIf="!hasActionButtons" class="d-flex flex-wrap gap-2 justify-content-center">
                          </div>

                        </div>
                      </div>
                    </ng-template>
                  </ng-template>

                </div>

              </div>
            </div>


            <div id="mainInfo">
              <!-- Permit Information Section -->
              <div class="main-container mb-4" *ngIf="requestAdvertisement?.parentMainApplyService">
                <div class="step-content mb-4">
                  <h5 class="mb-3 gold">{{ 'ADVERTISEMENT.PERMIT_INFORMATION' | translate }}</h5>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'mainApplyServiceResourceName.applyNo' | translate }}</label>
                      <p class="mb-0">{{ requestAdvertisement?.parentMainApplyService?.applyNo || '-' }}</p>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'mainApplyServiceResourceName.applyDate' | translate }}</label>
                      <p class="mb-0">{{ formatDate(requestAdvertisement?.parentMainApplyService?.applyDate) || '-' }}</p>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'mainApplyServiceResourceName.lastStatus' | translate }}</label>
                      <p class="mb-0">
                        <span class="badge badge-brown">
                          {{ getLocalizedStatus(requestAdvertisement?.parentMainApplyService?.lastStatus, requestAdvertisement?.parentMainApplyService?.lastStatusEN) }}
                        </span>
                      </p>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'mainApplyServiceResourceName.serviceName' | translate }}</label>
                      <p class="mb-0">{{ getLocalizedServiceName(requestAdvertisement?.parentMainApplyService?.service?.serviceName, requestAdvertisement?.parentMainApplyService?.service?.serviceNameEn) || '-' }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="main-container mb-4">
                <div class="step-content mb-4">
                  <h5 class="mb-3 gold">{{ 'SHARED.TABS.BASIC_INFORMATION' | translate }}</h5>

                  <div class="row" *ngIf="requestAdvertisement">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.TITLE' | translate }}</label>
                      <p class="mb-0">{{requestAdvertisement.adTitle || '-'}}</p>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.TARGETED_AMOUNT' | translate }}</label>
                      <p class="mb-0">{{requestAdvertisement.targetedAmount || '-'}}</p>
                    </div>

                    <div class="col-md-6 mb-3" *ngIf="requestAdvertisement.oldPermNumber">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.OLD_PERMIT_NUMBER' | translate }}</label>
                      <p class="mb-0">{{requestAdvertisement.oldPermNumber}}</p>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.STATUS' | translate }}</label>
                      <p class="mb-0">
                        <span class="badge badge-brown">{{ requestAdvertisement.advertisementStatusName }}</span>
                      </p>
                    </div>

                    <!-- Target Audiences Badges -->
                    <div class="col-md-12 mb-3" *ngIf="targets && targets.length > 0">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.TARGET_AUDIENCES' | translate }}</label>
                      <div class="d-flex flex-wrap gap-2">
                        <span *ngFor="let target of targets" class="badge badge-brown">
                          {{ target.lkpTargetTypeText || target.othertxt || '-' }}
                        </span>
                      </div>
                    </div>

                    <!-- Advertisement Methods Badges -->
                    <div class="col-md-12 mb-3" *ngIf="methods && methods.length > 0">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.METHODS' | translate }}</label>
                      <div class="d-flex flex-wrap gap-2">
                        <span *ngFor="let method of methods" class="badge badge-brown">
                          {{ method.lkpAdMethodText || method.othertxt || '-' }}
                        </span>
                      </div>
                    </div>

                    <!-- Advertisement Locations Badges -->
                    <div class="col-md-12 mb-3" *ngIf="locations && locations.length > 0">
                      <label class="form-label fw-bold">{{ 'ADVERTISEMENT.LOCATIONS' | translate }}</label>
                      <div class="d-flex flex-wrap gap-2">
                        <span *ngFor="let location of locations" class="badge badge-brown">
                          {{ location.lkpAdLocationText || location.othertxt || '-' }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="step-content">
                  <h5 class="mb-3 gold">{{ 'SHARED.TABS.DATE_DETAILS' | translate }}</h5>

                  <div class="row" *ngIf="requestAdvertisement">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'SHARED.FORMS.START_DATE' | translate }}</label>
                      <p class="mb-0">
                        {{formatDate(requestAdvertisement.startDate ?? null) || '-'}}
                      </p>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'SHARED.FORMS.END_DATE' | translate }}</label>
                      <p class="mb-0">
                        {{formatDate(requestAdvertisement.endDate ?? null) || '-'}}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="detailsInfo">
              <div class="accordion" id="accordionExample">

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                      {{ 'SHARED.ATTACHMENTS.TITLE' | translate }}
                    </button>
                  </h2>
                  <div id="collapseTwo" class="accordion-collapse collapse"
                       data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                      <div class="step-content">

                        <div *ngIf="attachments && attachments.length > 0">
                          <div class="row">
                            <div class="col-xl-4 col-lg-6 mb-4"
                                 *ngFor="let attachment of attachments">
                              <div class="attachment-box">
                                <h6 class="card-title">
                                  {{ attachment.attachmentTitle || ('SHARED.ATTACHMENTS.ATTACHMENT' | translate) }}
                                </h6>
                                <p class="mb-4">
                                  {{ 'COMMON.UPLOADED_ON' | translate }}:
                                  {{formatDateTime(attachment.lastModified)}}
                                </p>
                                <div class="d-flex justify-content-between mt-auto">
                                  <button class="btn btn-next-style me-2"
                                          (click)="viewAttachment(attachment)">
                                    <i class="fas fa-eye me-1"></i>
                                    {{ 'COMMON.VIEW' | translate }}
                                  </button>
                                  <button class="btn btn-download-style"
                                          (click)="downloadAttachment(attachment)">
                                    <i class="fas fa-download me-1"></i>
                                    {{ 'COMMON.DOWNLOAD' | translate }}
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="!attachments || attachments.length === 0"
                             class="alert alert-info">
                          {{ 'SHARED.ATTACHMENTS.NO_ATTACHMENTS' | translate }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="accordion-item  mb-4">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseThree" aria-expanded="false"
                            aria-controls="collapseThree">
                      {{ 'COMMON.WORKFLOW_COMMENTS' | translate }}
                    </button>
                  </h2>
                  <div id="collapseThree" class="accordion-collapse collapse"
                       data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                      <div class="step-content">
                        <!--<div class="d-flex justify-content-end align-items-center mb-4">
                          <button *ngIf="targetWorkFlowStep && isEditMode" type="button" class="btn btn-gold" data-bs-toggle="modal" data-bs-target="#addcommentsModal">
                            <i class="fas fa-plus me-2"></i>
                            {{ 'COMMON.ADD_COMMENT' | translate }}
                          </button>
                        </div>-->

                        <div *ngIf="isLoadingComments" class="text-center py-5">
                          <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">
                              {{ 'COMMON.LOADING' | translate }}
                            </span>
                          </div>
                          <span class="ms-2">{{ 'COMMON.LOADING_COMMENTS' | translate }}</span>
                        </div>
                        <div class="comments-container">
                          <div class="comment-item" *ngFor="let comment of allWorkFlowComments">
                            <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
                              <div>
                                <h5 class="mb-0">{{ comment.employeeDepartmentName || 'N/A' }}</h5>
                                <small class="text-muted">
                                  {{ comment.lastModified | date:'dd/MM/yyyy' }}
                                </small>
                              </div>
                            </div>
                            <div class="comment-area">
                              {{ comment.comment }}
                            </div>
                            <div>
                              <button class="btn btn-view-attachment mt-2" data-comment-id="${comment.id}" data-row-index="${p.node.rowIndex}" (click)="onTableCellClick($event,comment?.id)">
                                <i class="fas fa-eye me-1"></i>
                                {{ 'COMMON.VIEW' | translate}}
                              </button>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="!targetWorkFlowStep" class="alert alert-warning">
                          {{ 'COMMON.NO_WORKFLOW_STEP_FOUND' | translate }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="statusInfo">
              <div class="main-container mb-4">
                <div id="workFlowStep" class="mb-3">

                  <div *ngIf="allApproved; else normalWorkflow">
                    <div class="form-group mb-3">
                      <label for="NotesForApproving" class="control-label mb-2">
                        {{ 'mainApplyServiceResourceName.notesConsent' | translate }}
                      </label>
                      <textarea id="NotesForApproving" class="form-control" readonly>
   {{ mainApplyService.notesForApproving }}
 </textarea>
                    </div>

                    <div class="alert alert-success text-center">
                      {{ 'mainApplyServiceResourceName.agree' | translate }}
                    </div>
                  </div>
                  <ng-template #normalWorkflow>

                    <div *ngIf="!workFlowQuery?.length || workFlowQuery[0].serviceStatus == 4 || workFlowQuery[0].serviceStatus == 5; else readonlyNotes"
                         class="mt-3">
                      <div class="form-group mb-3">
                        <label for="NotesForApproving" class="control-label mb-2">
                          {{ 'mainApplyServiceResourceName.notesConsent' | translate }}
                        </label>
                        <textarea id="NotesForApproving" class="form-control"
                                  [(ngModel)]="mainApplyService.notesForApproving"
                                  (ngModelChange)="onNotesChange($event)" [disabled]="!isEditMode"></textarea>
                      </div>
                    </div>

                    <ng-template #readonlyNotes>
                      <div class="form-group mb-3">
                        <label for="NotesForApproving" class="control-label col-md-12">
                          {{ 'mainApplyServiceResourceName.notes' | translate }}
                        </label>
                        <textarea id="NotesForApproving" class="form-control" readonly> {{ mainApplyService.notesForApproving }}</textarea>
                      </div>
                    </ng-template>
                    <div *ngIf="workFlowQuery?.length; else noWorkflow">

                      <div *ngIf="workFlowQuery[0].serviceStatus == 1" class="alert alert-success text-center">
                        {{ 'mainApplyServiceResourceName.agree' | translate }}
                      </div>

                      <div *ngIf="workFlowQuery[0].serviceStatus == 2" class="alert alert-danger text-center">
                        {{ 'mainApplyServiceResourceName.disagree' | translate }}
                      </div>

                      <div *ngIf="workFlowQuery[0].serviceStatus == 7" class="alert alert-warning text-center">
                        <div class="popover__wrapper">
                          <a href="javascript:void(0);">
                            <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                          </a>
                          <div class="popover__content w-60">
                            <p class="popover__message">{{ workFlowQuery[0].refuseReason }}</p>
                          </div>
                        </div>
                      </div>

                      <ng-container *ngIf="workFlowQuery[0].serviceStatus != 1 && workFlowQuery[0].serviceStatus != 2 && workFlowQuery[0].serviceStatus != 7">
                        <ng-template #returnForModification>
                          <div class="alert alert-warning text-center">
                            <div class="popover__wrapper">
                              <a href="javascript:void(0);">
                                <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                              </a>
                              <div class="popover__content w-60">
                                <p class="popover__message">{{ mainApplyService.reasonForModification }}</p>
                              </div>
                            </div>
                          </div>
                        </ng-template>

                        <div *ngIf="mainApplyService.lastStatus != 'إرجاع للتعديل'; else returnForModification">
                          <div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">

                            <div *ngIf="serviceDepartmentActions?.includes(1)" class="d-flex flex-wrap gap-2 justify-content-center">
                              <button type="button" (click)="acceptbtn()" class="btn btn-success">
                                {{ 'mainApplyServiceResourceName.accep' | translate }}
                              </button>
                              <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                                {{ 'mainApplyServiceResourceName.refu' | translate }}
                              </button>
                            </div>

                            <div *ngIf="serviceDepartmentActions?.includes(2)" class="d-flex flex-wrap gap-2 justify-content-center">
                              <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                                {{ 'SERVICE_SETTING.DEPARTMENT_ACTION_REVIEW' | translate }}
                              </button>
                            </div>

                            <div *ngIf="serviceDepartmentActions?.includes(3)" class="d-flex flex-wrap gap-2 justify-content-center">
                              <button type="submit" (click)="returnForModificationsbtn()" class="btn btn-outline-secondary">
                                {{ 'mainApplyServiceResourceName.ReturnForModifications' | translate }}
                              </button>
                            </div>

                            <div *ngIf="!hasActionButtons" class="d-flex flex-wrap gap-2 justify-content-center">
                            </div>

                          </div>
                        </div>
                      </ng-container>
                    </div>

                    <ng-template #noWorkflow>
                      <ng-template #noWorkflowReturn>
                        <div class="alert alert-warning text-center">
                          <div class="popover__wrapper">
                            <a href="javascript:void(0);">
                              <span class="btn btn-info">{{ mainApplyService.lastStatus }}</span>
                            </a>
                            <div class="popover__content w-60">
                              <p class="popover__message">{{ mainApplyService.reasonForModification }}</p>
                            </div>
                          </div>
                        </div>
                      </ng-template>

                      <div *ngIf="mainApplyService.lastStatus != 'إرجاع للتعديل'; else noWorkflowReturn">
                        <div *ngIf="isEditMode" class="d-flex flex-wrap gap-2 justify-content-center">

                          <div *ngIf="serviceDepartmentActions?.includes(1)" class="d-flex flex-wrap gap-2 justify-content-center">
                            <button type="button" (click)="acceptbtn()" class="btn btn-success">
                              {{ 'mainApplyServiceResourceName.accep' | translate }}
                            </button>
                            <button type="button" (click)="rejectbtn()" class="btn btn-danger">
                              {{ 'mainApplyServiceResourceName.refu' | translate }}
                            </button>
                          </div>

                          <div *ngIf="serviceDepartmentActions?.includes(2)" class="d-flex flex-wrap gap-2 justify-content-center">
                            <button type="submit" (click)="custombtn()" class="btn btn-outline-secondary">
                              {{ 'SERVICE_SETTING.DEPARTMENT_ACTION_REVIEW' | translate }}
                            </button>
                          </div>

                          <div *ngIf="serviceDepartmentActions?.includes(3)" class="d-flex flex-wrap gap-2 justify-content-center">
                            <button type="submit" (click)="returnForModificationsbtn()" class="btn btn-outline-secondary">
                              {{ 'mainApplyServiceResourceName.ReturnForModifications' | translate }}
                            </button>
                          </div>

                          <div *ngIf="!hasActionButtons" class="d-flex flex-wrap gap-2 justify-content-center">
                          </div>

                        </div>
                      </div>
                    </ng-template>
                  </ng-template>

                </div>

              </div>
            </div>

          </div>
        </div>
      </div>

      <div *ngIf="!isLoading && !mainApplyService" class="alert alert-danger text-center">
        <h5>{{ 'COMMON.ERROR' | translate }}</h5>
        <p>{{ 'COMMON.DATA_NOT_FOUND' | translate }}</p>
        <button class="btn btn-secondary" (click)="goBack()">
          {{ 'COMMON.GO_BACK' | translate }}
        </button>
      </div>
    </div>
  </section>
</div>

<!-- Add Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">{{ 'COMMON.ADD_COMMENT' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form [formGroup]="commentForm" (ngSubmit)="addWorkFlowComment()">
          <div class="mb-3">
            <label for="commentText" class="form-label mb-2">{{ 'COMMON.COMMENT' | translate }}</label>
            <textarea class="form-control" id="commentText" rows="4" formControlName="comment"
                      placeholder="{{ 'COMMON.ENTER_COMMENT' | translate }}"
                      required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label mb-2">{{ 'COMMON.ATTACHMENTS' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</label>

            <!-- Comment Attachment Configurations -->
            <div *ngIf="commentAttachmentConfigs.length > 0" class="">
              <div>
                <div *ngFor="let config of commentAttachmentConfigs">

                  <div *ngIf="!commentSelectedFiles[config.id!] && !commentFilePreviews[config.id!]"
                       class="upload-area" (dragover)="onCommentDragOver($event)"
                       (dragleave)="onCommentDragLeave($event)"
                       (drop)="onCommentDrop($event, config.id!)" [class.drag-over]="isCommentDragOver"
                       [class.border-danger]="isCommentAttachmentMandatory(config.id!) && !commentSelectedFiles[config.id!] && !commentFilePreviews[config.id!] && commentValidationSubmitted"
                       [class.border-success]="commentSelectedFiles[config.id!] || commentFilePreviews[config.id!]">
                    <input type="file" class="d-none" [id]="'comment-file-' + config.id"
                           (change)="onCommentFileSelected($event, config.id!)"
                           accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    <label [for]="'comment-file-' + config.id" class="upload-label">
                      <i class="fas fa-cloud-upload-alt mb-2"></i>
                      <div>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</div>
                      <small class="text-muted">
                        {{
 'ATTACHMENTS.SUPPORTED_FORMATS' | translate
                        }}
                      </small>
                    </label>
                  </div>

                  <div *ngIf="commentSelectedFiles[config.id!] || commentFilePreviews[config.id!]"
                       class="uploaded-file">
                    <div class="d-flex align-items-center gap-2">
                      <div *ngIf="commentFilePreviews[config.id!]">
                        <img [src]="commentFilePreviews[config.id!]"
                             class="img-thumbnail uploaded-img"
                             *ngIf="commentSelectedFiles[config.id!].type?.startsWith('image/')"
                             [alt]="commentAttachments[config.id!].fileName || 'File'">
                      </div>
                      <span class="file-name">
                        {{
 commentAttachments[config.id!].fileName ||
                                                ('FASTING_TENT.FILE' |
                                                translate)
                        }}
                      </span>
                    </div>

                    <button *ngIf="commentSelectedFiles[config.id!] || commentFilePreviews[config.id!]"
                            type="button" class="btn-remove-uploaded-file"
                            (click)="removeCommentFile(config.id!)">

                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                           viewBox="0 0 24 24" fill="none">
                        <path d="M21 4H17.9C17.6679 2.87141 17.0538 1.85735 16.1613 1.12872C15.2687 0.40009 14.1522 0.00145452 13 0L11 0C9.8478 0.00145452 8.73132 0.40009 7.83875 1.12872C6.94618 1.85735 6.3321 2.87141 6.1 4H3C2.73478 4 2.48043 4.10536 2.29289 4.29289C2.10536 4.48043 2 4.73478 2 5C2 5.26522 2.10536 5.51957 2.29289 5.70711C2.48043 5.89464 2.73478 6 3 6H4V19C4.00159 20.3256 4.52888 21.5964 5.46622 22.5338C6.40356 23.4711 7.67441 23.9984 9 24H15C16.3256 23.9984 17.5964 23.4711 18.5338 22.5338C19.4711 21.5964 19.9984 20.3256 20 19V6H21C21.2652 6 21.5196 5.89464 21.7071 5.70711C21.8946 5.51957 22 5.26522 22 5C22 4.73478 21.8946 4.48043 21.7071 4.29289C21.5196 4.10536 21.2652 4 21 4ZM11 2H13C13.6203 2.00076 14.2251 2.19338 14.7316 2.55144C15.2381 2.90951 15.6214 3.41549 15.829 4H8.171C8.37858 3.41549 8.7619 2.90951 9.26839 2.55144C9.77487 2.19338 10.3797 2.00076 11 2ZM18 19C18 19.7956 17.6839 20.5587 17.1213 21.1213C16.5587 21.6839 15.7956 22 15 22H9C8.20435 22 7.44129 21.6839 6.87868 21.1213C6.31607 20.5587 6 19.7956 6 19V6H18V19Z"
                              fill="#5B5B5B" />
                        <path d="M10 18C10.2652 18 10.5196 17.8946 10.7071 17.7071C10.8946 17.5196 11 17.2652 11 17V11C11 10.7348 10.8946 10.4804 10.7071 10.2929C10.5196 10.1054 10.2652 10 10 10C9.73478 10 9.48043 10.1054 9.29289 10.2929C9.10536 10.4804 9 10.7348 9 11V17C9 17.2652 9.10536 17.5196 9.29289 17.7071C9.48043 17.8946 9.73478 18 10 18Z"
                              fill="#5B5B5B" />
                        <path d="M14 18C14.2652 18 14.5196 17.8946 14.7071 17.7071C14.8947 17.5196 15 17.2652 15 17V11C15 10.7348 14.8947 10.4804 14.7071 10.2929C14.5196 10.1054 14.2652 10 14 10C13.7348 10 13.4804 10.1054 13.2929 10.2929C13.1054 10.4804 13 10.7348 13 11V17C13 17.2652 13.1054 17.5196 13.2929 17.7071C13.4804 17.8946 13.7348 18 14 18Z"
                              fill="#5B5B5B" />
                      </svg>
                    </button>

                  </div>

                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{ 'COMMON.CANCEL' | translate }}
        </button>
        <button type="button" class="btn btn-gold" (click)="addWorkFlowComment()"
                [disabled]="!commentForm.get('comment')?.value?.trim() || isSavingComment">
          <span *ngIf="isSavingComment" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ 'COMMON.ADD_COMMENT' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="addcommentsModal" tabindex="-1" aria-labelledby="addcommentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl custom-modal-width">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addcommentsModalLabel">{{ 'COMMON.ADD_COMMENT' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="">
          <form [formGroup]="userForm">
            <div class="row">
              <div class="col-xl-12 mb-3">
                <label for="comment" class="form-label">{{ 'mainApplyServiceResourceName.Comments' | translate }}</label>
                <textarea id="comment" class="form-control" rows="3"
                          [ngClass]="{'is-invalid': userForm.get('comment')?.invalid && (userForm.get('comment')?.touched || submitted)}"
                          formControlName="comment"
                          placeholder="{{ 'comment' | translate }}"></textarea>
                <div *ngIf="userForm.get('comment')?.invalid && (userForm.get('comment')?.touched || submitted)"
                     class="invalid-feedback">
                </div>
              </div>

              <div class="col-xl-6 mb-3">
                <label for="commentTypeId" class="form-label">{{ 'mainApplyServiceResourceName.commentType' | translate }}</label>
                <select id="commentTypeId" class="form-select"
                        [ngClass]="{'is-invalid': userForm.get('commentTypeId')?.invalid && (userForm.get('commentTypeId')?.touched || submitted)}"
                        formControlName="commentTypeId">
                  <option [ngValue]="null">{{ 'SELECT' | translate }}</option>
                  <option [ngValue]=1>{{ 'Internal' | translate }}</option>
                  <option [ngValue]=2>{{ 'External' | translate }}</option>
                </select>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer mt-3">
        <button type="button" class="btn btn-gold" (click)="submitComment()">{{ 'Common.save' | translate }}</button>
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">{{ 'Common.Close' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Attachment Preview Modal -->
<div class="modal fade" id="attachmentModal" tabindex="-1" aria-labelledby="attachmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attachmentModalLabel">
          <i class="fas fa-paperclip me-2"></i>
          {{ 'COMMON.ATTACHMENTS' | translate }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Loading State -->
        <div *ngIf="isLoadingAttachments" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
          </div>
          <p class="mt-3 text-muted">{{ 'COMMON.LOADING_ATTACHMENTS' | translate }}</p>
        </div>

        <!-- No Attachments State -->
        <div *ngIf="!isLoadingAttachments && selectedCommentAttachments.length === 0"
             class="text-center text-muted py-4">
          <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
          <p>{{ 'COMMON.NO_ATTACHMENTS' | translate }}</p>
        </div>

        <!-- Attachments List -->
        <div *ngIf="!isLoadingAttachments && selectedCommentAttachments.length > 0" class="row g-3">
          <div *ngFor="let attachment of selectedCommentAttachments" class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body text-center p-3">
                <div class="mb-3">
                  <i class="fas fa-file-alt fa-2x text-primary"></i>
                </div>
                <h6 class="card-title small mb-2">
                  {{
 attachment.attachmentTitle ||
                                    ('SHARED.ATTACHMENTS.ATTACHMENT' | translate)
                  }}
                </h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                    <i class="fas fa-download me-1"></i>
                    {{ 'COMMON.DOWNLOAD' | translate }}
                  </button>
                  <button class="btn btn-next-style" (click)="viewAttachment(attachment)">
                    <i class="fas fa-eye me-1"></i>
                    {{ 'COMMON.VIEW' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myModalReject" tabindex="-1" aria-labelledby="editLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl custom-modal-width">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="editLabel">{{ 'mainApplyServiceResourceName.refusereason' | translate }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM15.36 14.3C15.65 14.59 15.65 15.07 15.36 15.36C15.21 15.51 15.02 15.58 14.83 15.58C14.64 15.58 14.45 15.51 14.3 15.36L12 13.06L9.7 15.36C9.55 15.51 9.36 15.58 9.17 15.58C8.98 15.58 8.79 15.51 8.64 15.36C8.35 15.07 8.35 14.59 8.64 14.3L10.94 12L8.64 9.7C8.35 9.41 8.35 8.93 8.64 8.64C8.93 8.35 9.41 8.35 9.7 8.64L12 10.94L14.3 8.64C14.59 8.35 15.07 8.35 15.36 8.64C15.65 8.93 15.65 9.41 15.36 9.7L13.06 12L15.36 14.3Z"
                  fill="#5B5B5B" />
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="">
          <form [formGroup]="rejectResonsForm">
            <div class="row">
              <div class="col-xl-12 mb-3">
                <label for="reasonTxt" class="form-label">
                  {{
 'mainApplyServiceResourceName.reason' | translate
                  }}
                </label>
                <textarea id="reasonTxt" class="form-control" rows="3"
                          [ngClass]="{'is-invalid': rejectResonsForm.get('reasonTxt')?.invalid && (rejectResonsForm.get('reasonTxt')?.touched || submitted)}"
                          formControlName="reasonTxt" placeholder="{{ 'reasonTxt' | translate }}"></textarea>
                <div *ngIf="rejectResonsForm.get('reasonTxt')?.invalid && (rejectResonsForm.get('reasonTxt')?.touched || submitted)"
                     class="invalid-feedback">
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer mt-3">
        <button type="button" class="btn btn-gold" (click)="rejectReasonSave()">
          {{
 'Common.save' | translate
          }}
        </button>
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{
 'Common.Close' | translate
          }}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myModalReturnModification" tabindex="-1" aria-labelledby="editLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl custom-modal-width">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="editLabel">سبب ارجاع الطلب للتعديل</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM15.36 14.3C15.65 14.59 15.65 15.07 15.36 15.36C15.21 15.51 15.02 15.58 14.83 15.58C14.64 15.58 14.45 15.51 14.3 15.36L12 13.06L9.7 15.36C9.55 15.51 9.36 15.58 9.17 15.58C8.98 15.58 8.79 15.51 8.64 15.36C8.35 15.07 8.35 14.59 8.64 14.3L10.94 12L8.64 9.7C8.35 9.41 8.35 8.93 8.64 8.64C8.93 8.35 9.41 8.35 9.7 8.64L12 10.94L14.3 8.64C14.59 8.35 15.07 8.35 15.36 8.64C15.65 8.93 15.65 9.41 15.36 9.7L13.06 12L15.36 14.3Z"
                  fill="#5B5B5B" />
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="">
          <form [formGroup]="returnModificationForm">
            <div class="row">
              <div class="col-xl-12 mb-3">
                <label for="returnModificationreasonTxt" class="form-label">
                  {{
 'mainApplyServiceResourceName.reason' |
                    translate
                  }}
                </label>
                <textarea id="returnModificationreasonTxt" class="form-control" rows="3"
                          [ngClass]="{'is-invalid': returnModificationForm.get('returnModificationreasonTxt')?.invalid && (returnModificationForm.get('returnModificationreasonTxt')?.touched || submitted)}"
                          formControlName="returnModificationreasonTxt"
                          placeholder="{{ 'returnModificationreasonTxt' | translate }}"></textarea>
                <div *ngIf="returnModificationForm.get('returnModificationreasonTxt')?.invalid && (returnModificationForm.get('returnModificationreasonTxt')?.touched || submitted)"
                     class="invalid-feedback">
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer mt-3">
        <button type="button" class="btn btn-gold" (click)="returnModficationReasonSave()">
          {{
 'Common.save' |
            translate
          }}
        </button>
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{
 'Common.Close' | translate
          }}
        </button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="historyModalLabel" class="modal-title">
          {{ 'mainApplyServiceResourceName.WORKFLOW.HISTORY' | translate }}
        </h5>
        <button type="button" class="btn-close" (click)="closeHistoryModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ng-container *ngIf="historyForModal?.length; else noHistory">

          <div class="history-timeline">
            <div class="history-item" *ngFor="let h of historyForModal; let i = index">
              <div class="dot"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <div class="step-status" [style.color]="getStatusColor(h.serviceStatus)">
                    <i [class]="getStatusIcon(h.serviceStatus)" class="me-1"></i>
                    {{h.serviceStatusName || (getStatusLabel(h.serviceStatus) | translate)}}
                  </div>
                  <small class="text-muted">
                    {{ h.historyDate | date:'medium' }}
                  </small>
                </div>

                <div class="mb-1">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.BY' | translate }}:</small>
                  <span>{{ h.userName }}</span>
                </div>

                <div class="mb-1" *ngIf="h.fromDepartmentName">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.FROM_DEPT' | translate }}:</small>
                  <span>{{ h.fromDepartmentName }}</span>
                </div>

                <div class="mb-1" *ngIf="h.toDepartmentName">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.TO_DEPT' | translate }}:</small>
                  <span>{{ h.toDepartmentName }}</span>
                </div>

                <div class="mb-1" *ngIf="getHistoryNote(h)">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.NOTE' | translate }}:</small>
                  <span>{{ getHistoryNote(h) }}</span>
                </div>

                <div class="mb-1" *ngIf="h.description">
                  <small class="text-muted">
                    {{
 'mainApplyServiceResourceName.WORKFLOW.DESCRIPTION' | translate
                    }}:
                  </small>
                  <span>{{ h.description }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noHistory>
          <div class="text-center text-muted py-4">
            {{ 'mainApplyServiceResourceName.WORKFLOW.NO_HISTORY' | translate }}
          </div>
        </ng-template>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeHistoryModal()">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>
