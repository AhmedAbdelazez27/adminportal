<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="title">{{ translate.instant('INITIATIVE.TITLE') || 'Initiative Management' }}</h1>
    <div class="d-flex gap-2">
      <button class="btn btn-gold" (click)="openAddModal()" [disabled]="isLoading">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path
            d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM18 12.75H12.75V18C12.75 18.41 12.41 18.75 12 18.75C11.59 18.75 11.25 18.41 11.25 18V12.75H6C5.59 12.75 5.25 12.41 5.25 12C5.25 11.59 5.59 11.25 6 11.25H11.25V6C11.25 5.59 11.59 5.25 12 5.25C12.41 5.25 12.75 5.59 12.75 6V11.25H18C18.41 11.25 18.75 11.59 18.75 12C18.75 12.41 18.41 12.75 18 12.75Z"
            fill="white" />
        </svg>
        {{ translate.instant('INITIATIVE.ADD') || 'Add Initiative' }}
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="filter-title mb-0">{{ 'Common.SearchTitle' | translate }}</h4>
      <button class="btn btn-filter" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilterTab">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path
            d="M17.7499 6.31657H13.0999C12.7749 6.31657 12.5166 6.05824 12.5166 5.73324C12.5166 5.40824 12.7749 5.1499 13.0999 5.1499H17.7499C18.0749 5.1499 18.3333 5.40824 18.3333 5.73324C18.3333 6.05824 18.0749 6.31657 17.7499 6.31657Z"
            fill="" />
          <path
            d="M5.35033 6.31657H2.25033C1.92533 6.31657 1.66699 6.05824 1.66699 5.73324C1.66699 5.40824 1.92533 5.1499 2.25033 5.1499H5.35033C5.67533 5.1499 5.93366 5.40824 5.93366 5.73324C5.93366 6.05824 5.66699 6.31657 5.35033 6.31657Z"
            fill="" />
          <path
            d="M8.44987 9.02523C10.2678 9.02523 11.7415 7.5515 11.7415 5.73356C11.7415 3.91562 10.2678 2.44189 8.44987 2.44189C6.63193 2.44189 5.1582 3.91562 5.1582 5.73356C5.1582 7.5515 6.63193 9.02523 8.44987 9.02523Z"
            fill="" />
          <path
            d="M17.7497 14.8415H14.6497C14.3247 14.8415 14.0664 14.5831 14.0664 14.2581C14.0664 13.9331 14.3247 13.6748 14.6497 13.6748H17.7497C18.0747 13.6748 18.3331 13.9331 18.3331 14.2581C18.3331 14.5831 18.0747 14.8415 17.7497 14.8415Z"
            fill="" />
          <path
            d="M6.90033 14.8415H2.25033C1.92533 14.8415 1.66699 14.5831 1.66699 14.2581C1.66699 13.9331 1.92533 13.6748 2.25033 13.6748H6.90033C7.22533 13.6748 7.48366 13.9331 7.48366 14.2581C7.48366 14.5831 7.21699 14.8415 6.90033 14.8415Z"
            fill="" />
          <path
            d="M11.5505 17.5584C13.3684 17.5584 14.8421 16.0847 14.8421 14.2668C14.8421 12.4488 13.3684 10.9751 11.5505 10.9751C9.73252 10.9751 8.25879 12.4488 8.25879 14.2668C8.25879 16.0847 9.73252 17.5584 11.5505 17.5584Z"
            fill="" />
        </svg>
      </button>
    </div>

    <div class="collapse" id="collapseFilterTab">
      <div class="card card-body">
        <div class="row mb-3">
          <div class="col-xl-6 mb-3">
            <label for="searchName" class="form-label">{{ translate.instant('INITIATIVE.SEARCH_NAME') || 'Search
              Initiative Name' }}</label>
            <input type="text" class="form-control" id="searchName"
              placeholder="{{ translate.instant('INITIATIVE.SEARCH_PLACEHOLDER') || 'Enter initiative name...' }}"
              [(ngModel)]="searchValue" name="searchName">
          </div>
        </div>

        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline" (click)="clear()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path
                d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16 12.75H8C7.59 12.75 7.25 12.41 7.25 12C7.25 11.59 7.59 11.25 8 11.25H16C16.41 11.25 16.75 11.59 16.75 12C16.75 12.41 16.41 12.75 16 12.75Z"
                fill="#5B5B5B" />
            </svg>
            {{ 'Common.Clear' | translate }}
          </button>
          <button class="btn btn-gold" (click)="onSearch()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path
                d="M11.5 21C16.7467 21 21 16.7467 21 11.5C21 6.25329 16.7467 2 11.5 2C6.25329 2 2 6.25329 2 11.5C2 16.7467 6.25329 21 11.5 21Z"
                stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M22 22L20 20" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            {{ 'Common.Search' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic Data Table -->
  <app-generic-data-table [rowData]="initiatives" [columnDefs]="columnDefs" [totalCount]="totalCount"
    [currentPage]="currentPage" [pageSize]="pageSize" [showActionColumn]="true" [rowActions]="rowActions"
    (pageChange)="onPageChange($event)" (search)="onSearch($event)" (actionClick)="onActionClick($event)">
  </app-generic-data-table>
</div>

<!-- Initiative Modal -->
<div class="modal fade" id="initiativeModal" tabindex="-1" aria-labelledby="initiativeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="initiativeModalLabel">
          {{ mode === 'add' ? (translate.instant('INITIATIVE.ADD') || 'Add Initiative') :
          mode === 'edit' ? (translate.instant('INITIATIVE.EDIT') || 'Edit Initiative') :
          (translate.instant('INITIATIVE.VIEW') || 'View Initiative') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
          (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="initiativeForm" (ngSubmit)="submit()" id="initiativeForm">
          <!-- Initiative Basic Information -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">{{ translate.instant('INITIATIVE.INITIATIVE_INFORMATION') || 'Initiative Information' }}
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nameAr" class="form-label required">{{ translate.instant('INITIATIVE.NAME_AR') ||
                    'Initiative Name (Arabic)' }}</label>
                  <input type="text" class="form-control" id="nameAr" formControlName="nameAr"
                    [class.is-invalid]="isFieldInvalid('nameAr')" [class.is-valid]="isFieldValid('nameAr')"
                    (blur)="onFieldBlur('nameAr')" [disabled]="mode === 'view'"
                    placeholder="{{ translate.instant('INITIATIVE.NAME_AR_PLACEHOLDER') || 'Enter initiative name in Arabic' }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('nameAr')">
                    {{ getFieldError('nameAr') }}
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="nameEn" class="form-label">{{ translate.instant('INITIATIVE.NAME_EN') || 'Initiative Name
                    (English)' }}</label>
                  <input type="text" class="form-control" id="nameEn" formControlName="nameEn"
                    [class.is-invalid]="isFieldInvalid('nameEn')" [class.is-valid]="isFieldValid('nameEn')"
                    (blur)="onFieldBlur('nameEn')" [disabled]="mode === 'view'"
                    placeholder="{{ translate.instant('INITIATIVE.NAME_EN_PLACEHOLDER') || 'Enter initiative name in English' }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('nameEn')">
                    {{ getFieldError('nameEn') }}
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label for="targetGroup" class="form-label required">{{
                    translate.instant('INITIATIVE.TARGET_GROUP_AR')
                    || 'Target Group' }}</label>
                  <input type="text" class="form-control" id="targetGroup" formControlName="targetGroup"
                    [class.is-invalid]="isFieldInvalid('targetGroup')" [class.is-valid]="isFieldValid('targetGroup')"
                    (blur)="onFieldBlur('targetGroup')" [disabled]="mode === 'view'"
                    placeholder="{{ translate.instant('INITIATIVE.TARGET_GROUP_PLACEHOLDER_AR') || 'Enter target group' }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('targetGroup')">
                    {{ getFieldError('targetGroup') }}
                  </div>
                </div>
                <div class="col-md-12 mb-3">
                  <label for="targetGroupEn" class="form-label required">{{
                    translate.instant('INITIATIVE.TARGET_GROUP_EN')
                    || 'Target Group' }}</label>
                  <input type="text" class="form-control" id="targetGroupEn" formControlName="targetGroupEn"
                    [class.is-invalid]="isFieldInvalid('targetGroupEn')"
                    [class.is-valid]="isFieldValid('targetGroupEn')" (blur)="onFieldBlur('targetGroupEn')"
                    [disabled]="mode === 'view'"
                    placeholder="{{ translate.instant('INITIATIVE.TARGET_GROUP_PLACEHOLDER_EN') || 'Enter target group' }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('targetGroupEn')">
                    {{ getFieldError('targetGroupEn') }}
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label for="initiativeDate" class="form-label required">{{ translate.instant('INITIATIVE.DATE') ||
                    'Initiative Date' }}</label>
                  <input type="date" class="form-control" id="initiativeDate" formControlName="initiativeDate"
                    [class.is-invalid]="isFieldInvalid('initiativeDate')"
                    [class.is-valid]="isFieldValid('initiativeDate')" (blur)="onFieldBlur('initiativeDate')"
                    [disabled]="mode === 'view'">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('initiativeDate')">
                    {{ getFieldError('initiativeDate') }}
                  </div>
                </div>




                <div class="col-12 mb-3" [attr.dir]="translate.currentLang === 'ar' ? 'rtl' : 'ltr'">
                  <label for="descriptionAr" class="form-label required">
                    {{ translate.instant('INITIATIVE.DESCRIPTION_AR') || 'Description (Arabic)' }}
                  </label>
                  <br />


                  <angular-editor id="descriptionAr" class="w-100" theme="snow"
                    [ngClass]="{ 'is-invalid': isFieldInvalid('descriptionAr'), 'is-valid': isFieldValid('descriptionAr') }"
                    (blur)="onFieldBlur('descriptionAr')"
                    placeholder="{{ translate.instant('INITIATIVE.DESCRIPTION_AR_PLACEHOLDER') || 'Enter description in Arabic' }}"
                    formControlName="descriptionAr"></angular-editor>

                  <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('descriptionAr')">
                    {{ getFieldError('descriptionAr') }}
                  </div>
                </div>






                <div class="col-12 mb-3" [attr.dir]="translate.currentLang === 'ar' ? 'rtl' : 'ltr'">
                  <label for="descriptionEn" class="form-label required">
                    {{ translate.instant('INITIATIVE.DESCRIPTION_EN') || 'Description (English)' }}
                  </label>
                  <br />


                  <angular-editor id="descriptionEn" formControlName="descriptionEn" theme="snow"
                    [ngClass]="{ 'is-invalid': isFieldInvalid('descriptionEn'), 'is-valid': isFieldValid('descriptionEn') }"
                    (blur)="onFieldBlur('descriptionEn')"
                    placeholder="{{ translate.instant('INITIATIVE.DESCRIPTION_EN_PLACEHOLDER') || 'Enter description in English' }}"></angular-editor>

                  <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('descriptionEn')">
                    {{ getFieldError('descriptionEn') }}
                  </div>
                </div>

                <div class="col-md-3 mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="isActive" formControlName="isActive"
                      [disabled]="mode === 'view'">
                    <label class="form-check-label" for="isActive">{{ translate.instant('INITIATIVE.IS_ACTIVE') ||
                      'Active' }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>



          <!-- Image Upload Section -->
          <div class="card mb-3" *ngIf="attachmentConfigs.length > 0 && mode !== 'view'">
            <div class="card-header">
              <h6 class="mb-0">{{ translate.instant('INITIATIVE.IMAGE') || 'Initiative Image' }}</h6>
            </div>
            <div class="card-body">
              <!-- File Upload Area -->
              <div class="file-upload-area border rounded p-3 text-center" [class.drag-over]="isDragOver"
                [class.has-file]="selectedFile || existingImageUrl" (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)" (drop)="onDrop($event)" (click)="fileInput.click()"
                style="cursor: pointer; min-height: 120px; display: flex; align-items: center; justify-content: center; flex-direction: column;">

                <!-- Show existing image -->
                <div *ngIf="existingImageUrl && !selectedFile" class="existing-image-container">
                  <img [src]="existingImageUrl" [alt]="translate.instant('INITIATIVE.IMAGE') || 'Initiative Image'"
                    class="img-thumbnail mb-2" style="max-width: 200px; max-height: 150px; object-fit: cover;"
                    (load)="onImageLoad($event)" (error)="onImageError($event)" />
                  <div class="image-actions">
                    <button type="button" class="btn btn-sm btn-outline"
                      (click)="openImageInNewTab(); $event.stopPropagation()">
                      <i class="fa fa-external-link"></i> {{ translate.instant('COMMON.VIEW') || 'View' }}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                      (click)="removeExistingImage(); $event.stopPropagation()">
                      <i class="fa fa-trash"></i> {{ translate.instant('COMMON.REMOVE') || 'Remove' }}
                    </button>
                  </div>
                  <small class="text-muted d-block mt-2">{{ translate.instant('INITIATIVE.FILE_UPLOAD.CLICK_TO_REPLACE')
                    || 'Click here to replace with a new image' }}</small>
                </div>

                <!-- Show selected file preview -->
                <div *ngIf="selectedFile" class="selected-file-container">
                  <div *ngIf="filePreview" class="file-preview mb-2">
                    <img [src]="filePreview" [alt]="translate.instant('COMMON.PREVIEW') || 'Preview'"
                      class="img-thumbnail" style="max-width: 200px; max-height: 150px; object-fit: cover;">
                  </div>
                  <div *ngIf="!filePreview" class="file-info">
                    <i class="fa fa-file fa-2x text-primary mb-2"></i>
                    <p class="mb-1">{{ selectedFile.name }}</p>
                    <small class="text-muted">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                    (click)="removeFile(); $event.stopPropagation()">
                    <i class="fa fa-trash"></i> {{ translate.instant('COMMON.REMOVE_FILE') || 'Remove File' }}
                  </button>
                </div>

                <!-- Show upload area when no file -->
                <div *ngIf="!selectedFile && !existingImageUrl" class="upload-prompt">
                  <i class="fa fa-cloud-upload fa-2x text-primary mb-2"></i>
                  <p class="mb-1">{{ translate.instant('INITIATIVE.FILE_UPLOAD.DRAG_DROP_TEXT') || 'Drag and drop your
                    file here or click to browse' }}</p>
                  <small class="text-muted">{{ translate.instant('INITIATIVE.FILE_UPLOAD.SUPPORTED_FORMATS') ||
                    'Supports: JPG, PNG, PDF (Max: 2MB)' }}</small>
                </div>
              </div>

              <!-- Hidden file input -->
              <input #fileInput type="file" id="initiativeImage" class="d-none" accept=".jpg,.jpeg,.png,.pdf"
                (change)="onFileSelected($event)" />

              <!-- File validation messages -->
              <div *ngIf="fileValidationErrors.length > 0" class="text-danger mt-2">
                <small *ngFor="let error of fileValidationErrors">{{ error }}<br></small>
              </div>

              <div *ngIf="fileValidationSuccess" class="text-success mt-2">
                <small><i class="fa fa-check"></i> {{ translate.instant('INITIATIVE.FILE_UPLOAD.FILE_VALID') || 'File is
                  valid and ready for upload' }}</small>
              </div>
            </div>
          </div>
        </form>

        <!-- Initiative Details Section (Toggle) -->
        <div class="row initiative-details-section"
          *ngIf="mode !== 'view' || (mode === 'view' && initiativeDetailsFormArray.length > 0)">
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">{{ translate.instant('INITIATIVE.DETAILS_TITLE') || 'Initiative Details' }}</h6>
                <button type="button" class="btn btn-gold btn-sm" (click)="openAddDetailModal()"
                  *ngIf="mode !== 'view'">
                  <i class="fas fa-plus me-1"></i>
                  {{ translate.instant('INITIATIVE.ADD_DETAIL') || 'Add Location Detail' }}
                </button>
              </div>
              <div class="card-body">

                <!-- Initiative Details List -->
                <div *ngIf="initiativeDetailsFormArray.length > 0">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>{{ translate.instant('INITIATIVE.LOCATION_NAME_AR') || 'Location Name (Arabic)' }}</th>
                          <th>{{ translate.instant('INITIATIVE.LOCATION_NAME_EN') || 'Location Name (English)' }}</th>
                          <th>{{ translate.instant('INITIATIVE.COORDINATES') || 'Coordinates' }}</th>
                          <th>{{ translate.instant('INITIATIVE.IS_ACTIVE') || 'Status' }}</th>
                          <th *ngIf="mode !== 'view'">{{ 'COMMON.ACTIONS' | translate }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let detail of initiativeDetailsFormArray.controls; let i = index">
                          <td>{{ i + 1 }}</td>
                          <td>{{ detail.get('locationNameAr')?.value }}</td>
                          <td>{{ detail.get('locationNameEn')?.value }}</td>
                          <td>{{ detail.get('locationCoordinates')?.value }}</td>
                          <td>
                            <span class="badge" [class.bg-success]="detail.get('isActive')?.value"
                              [class.bg-secondary]="!detail.get('isActive')?.value">
                              {{ detail.get('isActive')?.value ? (translate.instant('COMMON.ACTIVE') || 'Active') :
                              (translate.instant('COMMON.INACTIVE') || 'Inactive') }}
                            </span>
                          </td>
                          <td *ngIf="mode !== 'view'">
                            <button type="button" class="btn btn-sm btn-outline-danger"
                              (click)="selectDetailToDelete(detail.value, i)"
                              [title]="translate.instant('COMMON.DELETE') || 'Delete'">
                              <i class="fas fa-trash"></i>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div *ngIf="initiativeDetailsFormArray.length === 0">
                  <p class="text-muted text-center">{{ translate.instant('INITIATIVE.NO_DETAILS') || 'No location
                    details added yet.' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attachment Gallery Section for View Mode -->
        <div class="row" *ngIf="mode === 'view'">
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0 text-primary">
                  <i class="fa fa-images me-2"></i>
                  {{ translate.instant('INITIATIVE.ATTACHMENTS') || 'Initiative Attachments' }}
                  <span class="badge bg-secondary ms-2">{{ attachmentsForGallery.length }}</span>
                </h6>
              </div>
              <div class="card-body">
                <div *ngIf="attachmentsForGallery.length > 0">
                  <app-attachment-gallery [attachments]="attachmentsForGallery"></app-attachment-gallery>
                </div>
                <div *ngIf="attachmentsForGallery.length === 0" class="text-center text-muted">
                  <p>{{ translate.instant('INITIATIVE.FILE_UPLOAD.NO_ATTACHMENTS') || 'No attachments found for this
                    initiative.' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Image Display Section for View Mode -->
        <div class="row" *ngIf="mode === 'view' && existingImageUrl">
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0 text-primary">
                  <i class="fa fa-image me-2"></i>
                  {{ translate.instant('INITIATIVE.IMAGE') || 'Initiative Image' }}
                </h6>
              </div>
              <div class="card-body">
                <div class="view-image-container text-center">
                  <img [src]="existingImageUrl" [alt]="translate.instant('INITIATIVE.IMAGE') || 'Initiative Image'"
                    class="img-fluid rounded" style="max-width: 100%; max-height: 400px; object-fit: contain;"
                    (load)="onImageLoad($event)" (error)="onImageError($event)" />
                  <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="openImageInNewTab()">
                      <i class="fa fa-external-link-alt me-1"></i>
                      {{ translate.instant('COMMON.VIEW_FULL_SIZE') || 'View Full Size' }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" *ngIf="mode !== 'view'">
        <button type="button" class="btn btn-outline" (click)="closeModal()">
          {{ translate.instant('COMMON.CANCEL') || 'Cancel' }}
        </button>
        <button type="submit" form="initiativeForm" class="btn btn-gold"
        [disabled]="initiativeForm.invalid || isLoading">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          {{ mode === 'add' ? (translate.instant('COMMON.CREATE') || 'Create') : (translate.instant('COMMON.UPDATE') ||
          'Update') }}
        </button>
      </div>
      <div class="modal-footer" *ngIf="mode === 'view'">
        <button type="button" class="btn btn-outline" (click)="closeModal()">
          {{ translate.instant('COMMON.CLOSE') || 'Close' }}
        </button>
      </div>
    </div>
  </div>





  <!-- Initiative Detail (Location) Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel">
            {{ detailsMode === 'add' ? (translate.instant('INITIATIVE.ADD_DETAIL') || 'Add Location Detail') :
            detailsMode === 'edit' ? (translate.instant('INITIATIVE.EDIT_DETAIL') || 'Edit Location Detail') :
            (translate.instant('INITIATIVE.VIEW_DETAIL') || 'View Location Detail') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
            (click)="closeDetailModal()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="detailsForm">
            <!-- Location Detail Information -->
            <div class="card mb-3">
              <div class="card-header">

              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label required">{{ translate.instant('INITIATIVE.LOCATION_NAME_AR') || 'Location
                      Name (Arabic)' }}</label>
                    <input type="text" class="form-control" formControlName="locationNameAr"
                      [class.is-invalid]="isDetailFieldInvalid('locationNameAr')"
                      [class.is-valid]="isDetailFieldValid('locationNameAr')"
                      [placeholder]="translate.instant('INITIATIVE.LOCATION_NAME_AR') || 'Location Name (Arabic)'" />
                    <div class="invalid-feedback" *ngIf="isDetailFieldInvalid('locationNameAr')">
                      {{ getDetailFieldError('locationNameAr') }}
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label required">{{ translate.instant('INITIATIVE.LOCATION_NAME_EN') || 'Location
                      Name (English)' }}</label>
                    <input type="text" class="form-control" formControlName="locationNameEn"
                      [class.is-invalid]="isDetailFieldInvalid('locationNameEn')"
                      [class.is-valid]="isDetailFieldValid('locationNameEn')"
                      [placeholder]="translate.instant('INITIATIVE.LOCATION_NAME_EN') || 'Location Name (English)'" />
                    <div class="invalid-feedback" *ngIf="isDetailFieldInvalid('locationNameEn')">
                      {{ getDetailFieldError('locationNameEn') }}
                    </div>
                  </div>

                  <div class="col-12 mb-3">
                    <label class="form-label required">{{ translate.instant('INITIATIVE.COORDINATES') || 'Location
                      Coordinates' }}</label>
                    <div class="input-group coordinate-input-group">
                      <input type="text" class="form-control" formControlName="locationCoordinates"
                        [class.is-invalid]="isDetailFieldInvalid('locationCoordinates')"
                        [class.is-valid]="isDetailFieldValid('locationCoordinates')" placeholder="25.2048/55.2708"
                        [readonly]="false" (keypress)="onCoordinateInputKeyPress($event)" />
                      <button type="button" class="btn btn-outline-primary" (click)="onManualCoordinateInput()"
                        [disabled]="detailsMode === 'view' || !detailsForm.get('locationCoordinates')?.value"
                        title="{{ translate.instant('INITIATIVE.MAP.SET_COORDINATES') || 'Set coordinates' }}">
                        <i class="fa fa-map-marker"></i>
                      </button>
                      <button type="button" class="btn btn-outline-secondary"
                        (click)="getCoordinatesFromDetailAddress()"
                        [disabled]="detailsMode === 'view' || !detailsForm.get('locationNameEn')?.value">
                        <i class="fa fa-search"></i>
                      </button>
                      <button type="button" class="btn btn-outline-info" (click)="useCurrentLocation()"
                        [disabled]="detailsMode === 'view'"
                        title="{{ translate.instant('INITIATIVE.MAP.USE_CURRENT_LOCATION') || 'Use current location' }}">
                        <i class="fa fa-location-arrow"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger" (click)="clearDetailsCoordinates()"
                        [disabled]="detailsMode === 'view'">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                    <div class="invalid-feedback" *ngIf="isDetailFieldInvalid('locationCoordinates')">
                      {{ getDetailFieldError('locationCoordinates') }}
                    </div>

                  </div>

                  <!-- Address from coordinates display -->
                  <div class="col-12 mb-3" *ngIf="addressFromCoordinates">
                    <label class="form-label">{{ translate.instant('INITIATIVE.MAP.ADDRESS_FROM_COORDINATES') ||
                      'Address from Coordinates' }}</label>
                    <div class="form-control-plaintext address-display">
                      <small>{{ getAddressDisplayText() }}</small>
                    </div>
                  </div>

                  <!-- Loading indicator -->
                  <div class="col-12 mb-3 loading-indicator" *ngIf="isMapLoading">
                    <div class="alert alert-info">
                      <i class="fa fa-spinner fa-spin"></i>
                      {{ translate.instant('INITIATIVE.MAP.LOADING_ADDRESS') || 'Loading address information...' }}
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="detailIsActive" formControlName="isActive" />
                      <label class="form-check-label" for="detailIsActive">
                        {{ translate.instant('INITIATIVE.IS_ACTIVE') || 'Active' }}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Map Section -->
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <!-- <h6 class="mb-0">{{ translate.instant('INITIATIVE.MAP') || 'Location Map' }}</h6> -->
                <div class="btn-group btn-group-sm map-controls" role="group" *ngIf="detailsMode !== 'view'">
                  <button type="button" class="btn btn-outline-primary" (click)="useCurrentLocation()"
                    title="{{ translate.instant('INITIATIVE.MAP.USE_CURRENT_LOCATION') || 'Use current location' }}">
                    <i class="fa fa-location-arrow"></i> {{ translate.instant('INITIATIVE.MAP.CURRENT_LOCATION') ||
                    'Current' }}
                  </button>
                  <button type="button" class="btn btn-outline-secondary" (click)="clearDetailsCoordinates()"
                    title="{{ translate.instant('INITIATIVE.MAP.CLEAR_COORDINATES') || 'Clear coordinates' }}">
                    <i class="fa fa-times"></i> {{ translate.instant('INITIATIVE.MAP.CLEAR') || 'Clear' }}
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div id="detailsMap"
                  style="height: 400px; width: 100%; border: 1px solid #ddd; border-radius: 0.375rem; position: relative;">
                  <div class="map-loading" *ngIf="isMapLoading"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                    <div class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading map...</span>
                      </div>
                      <div class="mt-2">{{ translate.instant('INITIATIVE.MAP.LOADING') || 'Loading map...' }}</div>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="row">
                    <div class="col-md-6">
                      <small class="form-text text-muted">
                        <i class="fa fa-info-circle"></i>
                        {{ detailsMode === 'view' ?
                        (translate.instant('INITIATIVE.MAP.VIEW_INSTRUCTIONS') || 'Location marker displayed on map') :
                        (translate.instant('INITIATIVE.MAP.EDIT_INSTRUCTIONS') || 'Click on the map to set location
                        coordinates. You can drag the marker to adjust the position.') }}
                      </small>
                    </div>
                    <div class="col-md-6 text-end coordinate-status" *ngIf="selectedCoordinates">
                      <small class="form-text text-success">
                        <i class="fa fa-check-circle"></i>
                        {{ translate.instant('INITIATIVE.MAP.COORDINATES_SELECTED') || 'Coordinates selected' }}:
                        {{ selectedCoordinates.lat.toFixed(6) }}, {{ selectedCoordinates.lng.toFixed(6) }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer" *ngIf="detailsMode !== 'view'">
          <button type="button" class="btn btn-outline" (click)="closeDetailModal()">
            {{ translate.instant('COMMON.CANCEL') || 'Cancel' }}
          </button>
          <button type="button" class="btn btn-gold" (click)="saveInitiativeDetail()" [disabled]="detailsForm.invalid">
            {{ detailsMode === 'add' ? (translate.instant('COMMON.CREATE') || 'Create') :
            (translate.instant('COMMON.UPDATE') || 'Update') }}
          </button>
        </div>
        <div class="modal-footer" *ngIf="detailsMode === 'view'">
          <button type="button" class="btn btn-outline" (click)="closeDetailModal()">
            {{ translate.instant('COMMON.CLOSE') || 'Close' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Initiative Modal -->
  <div class="modal fade" id="deleteInitiativeModal" tabindex="-1" aria-labelledby="deleteInitiativeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteInitiativeModalLabel">{{
            translate.instant('INITIATIVE.DELETE_CONFIRM_TITLE') || 'Confirm Delete' }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>{{ translate.instant('INITIATIVE.DELETE_CONFIRM') || 'Are you sure you want to delete this initiative?' }}
          </p>
          <div *ngIf="selectedInitiativeToDelete" class="delete-confirmation-details">
            <strong>{{ translate.instant('INITIATIVE.NAME_AR') || 'Initiative Name (Arabic)' }}:</strong> {{
            selectedInitiativeToDelete.nameAr || 'N/A' }}<br>
            <strong>{{ translate.instant('INITIATIVE.NAME_EN') || 'Initiative Name (English)' }}:</strong> {{
            selectedInitiativeToDelete.nameEn || 'N/A' }}<br>
            <strong>{{ translate.instant('INITIATIVE.TARGET_GROUP_AR') || 'Target Group (Arabic)' }}:</strong> {{
            selectedInitiativeToDelete.targetGroup || 'N/A' }}<br>
            <strong>{{ translate.instant('INITIATIVE.TARGET_GROUP_EN') || 'Target Group (English)' }}:</strong> {{
            selectedInitiativeToDelete.targetGroupEn || 'N/A' }}<br>
            <strong>{{ translate.instant('INITIATIVE.DATE') || 'Initiative Date' }}:</strong> {{
            selectedInitiativeToDelete.initiativeDate ? (selectedInitiativeToDelete.initiativeDate | date:'shortDate') :
            'N/A' }}<br>
            <strong>{{ translate.instant('COMMON.STATUS') || 'Status' }}:</strong> {{
            selectedInitiativeToDelete.isActive ? (translate.instant('COMMON.ACTIVE') || 'Active') :
            (translate.instant('COMMON.INACTIVE') || 'Inactive') }}<br>
            <strong>{{ translate.instant('INITIATIVE.DESCRIPTION_AR') || 'Description (Arabic)' }}:</strong> {{
            selectedInitiativeToDelete.descriptionAr || 'N/A' }}<br>
            <strong>{{ translate.instant('INITIATIVE.DESCRIPTION_EN') || 'Description (English)' }}:</strong> {{
            selectedInitiativeToDelete.descriptionEn || 'N/A' }}
          </div>
          <p class="text-danger">{{ translate.instant('COMMON.DELETE_WARNING') || 'This action cannot be undone.' }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" data-bs-dismiss="modal">{{ translate.instant('COMMON.CANCEL') ||
            'Cancel' }}</button>
          <button type="button" class="btn btn-danger" (click)="deleteInitiative()" data-bs-dismiss="modal">{{
            translate.instant('COMMON.DELETE') || 'Delete' }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Detail Modal -->
  <div class="modal fade" id="deleteDetailModal" tabindex="-1" aria-labelledby="deleteDetailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteDetailModalLabel">{{ translate.instant('INITIATIVE.DELETE_DETAIL') ||
            'Delete Location Detail' }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>{{ translate.instant('INITIATIVE.DELETE_DETAIL_CONFIRM') || 'Are you sure you want to delete this location
            detail?' }}</p>
          <p *ngIf="selectedDetailToDelete" class="text-muted">
            <strong>{{ selectedDetailToDelete.locationNameEn }}</strong>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ translate.instant('COMMON.CANCEL') || 'Cancel' }}
          </button>
          <button type="button" class="btn btn-danger" (click)="deleteDetail()" data-bs-dismiss="modal">
            {{ translate.instant('COMMON.DELETE') || 'Delete' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Attachment Modal -->
  <div class="modal fade" id="deleteAttachmentModal" tabindex="-1" aria-labelledby="deleteAttachmentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteAttachmentModalLabel">{{ translate.instant('COMMON.DELETE_ATTACHMENT') ||
            'Delete Attachment' }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>{{ translate.instant('COMMON.DELETE_ATTACHMENT_CONFIRM') || 'Are you sure you want to delete this
            attachment?' }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cancelDeleteAttachment()">
            {{ translate.instant('COMMON.CANCEL') || 'Cancel' }}
          </button>
          <button type="button" class="btn btn-danger" (click)="confirmDeleteAttachment()" data-bs-dismiss="modal">
            {{ translate.instant('COMMON.DELETE') || 'Delete' }}
          </button>
        </div>
      </div>
    </div>
  </div>